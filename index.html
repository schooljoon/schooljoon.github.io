<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Colorful Kids Drawing App</title>
    <style>
        /* CSS Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Comic Sans MS', cursive, sans-serif;
        }
        
        body {
            background-color: #f0f8ff;
            overflow-x: hidden;
        }
        
        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1 {
            color: #ff6b6b;
            text-align: center;
            margin-bottom: 20px;
            font-size: 2.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        
        .drawing-app {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            position: relative;
        }
        
        .canvas-container {
            position: relative;
            border: 8px solid #ffcc5c;
            border-radius: 10px;
            margin: 15px 0;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            background-color: white;
            overflow: hidden;
        }
        
        #drawing-canvas {
            display: block;
            cursor: crosshair;
            background-color: white;
            touch-action: none;
        }
        
        .tools {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
            width: 100%;
        }
        
        .left-panel, .right-panel {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 80px;
            background-color: white;
            border-radius: 10px;
            padding: 10px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 10;
        }
        
        .left-panel {
            left: 10px;
        }
        
        .right-panel {
            right: 10px;
        }
        
        .panel-title {
            font-size: 0.9rem;
            font-weight: bold;
            color: #333;
            text-align: center;
            margin-bottom: 5px;
            border-bottom: 2px dashed #ddd;
            padding-bottom: 5px;
        }
        
        .color-picker {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .color-option {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.2s;
            border: 3px solid #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .color-option:hover {
            transform: scale(1.1);
        }
        
        .color-option.selected {
            border: 3px solid #333;
            transform: scale(1.1);
        }
        
        .btn {
            padding: 10px;
            border: none;
            border-radius: 25px;
            background-color: #74b9ff;
            color: white;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        
        .btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .btn-undo {
            background-color: #ff9f43;
        }
        
        .btn-clear {
            background-color: #ff6b6b;
        }
        
        .btn-save {
            background-color: #10ac84;
        }
        
        .stickers-container, .shapes-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 5px;
            max-width: 70px;
        }
        
        .sticker {
            width: 30px;
            height: 30px;
            cursor: pointer;
            transition: transform 0.2s;
            background-color: #f9f9f9;
            border-radius: 8px;
            padding: 2px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .sticker:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .sticker.selected, .shape-btn.selected {
            background-color: #ddeeff;
            transform: scale(1.1);
            border: 2px solid #74b9ff;
        }
        
        .sticker svg {
            width: 24px;
            height: 24px;
        }
        
        .shape-btn {
            width: 30px;
            height: 30px;
            font-size: 18px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .size-picker {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 10px;
            background-color: white;
            padding: 5px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .size-picker label {
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
            font-size: 0.8rem;
        }
        
        .size-picker input {
            width: 100%;
        }
        
        .tool-type {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-bottom: 10px;
        }
        
        .tool-btn {
            padding: 8px 5px;
            border: none;
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s;
            background-color: #ddd;
            color: #333;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .tool-btn.active {
            background-color: #74b9ff;
            color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .gallery {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
            background-color: rgba(255, 255, 255, 0.7);
            border-radius: 10px;
        }
        
        .saved-drawing {
            width: 120px;
            height: 90px;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: transform 0.2s;
            position: relative;
        }
        
        .saved-drawing:hover {
            transform: scale(1.05);
        }
        
        .delete-drawing {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ff6b6b;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
            font-weight: bold;
            border: 2px solid white;
        }
        
        .saved-drawing:hover .delete-drawing {
            opacity: 1;
        }
        
        .section-title {
            font-size: 1.5rem;
            color: #333;
            margin: 15px 0 10px;
            text-align: center;
            width: 100%;
        }
        
        .drawing-name-input {
            padding: 10px 15px;
            border: 2px solid #74b9ff;
            border-radius: 25px;
            font-size: 1rem;
            margin-bottom: 15px;
            width: 250px;
            text-align: center;
        }
        
        @media (max-width: 768px) {
            .tools {
                flex-direction: column;
                align-items: center;
            }
            
            .canvas-container {
                width: 100%;
                max-width: 90vw;
                margin-top: 60px; /* Space for panels */
            }
            
            #drawing-canvas {
                width: 100%;
                height: auto;
            }
            
            .color-picker, .stickers-container, .shapes-container {
                max-width: 90vw;
            }
            
            .left-panel, .right-panel {
                position: relative;
                top: auto;
                left: auto;
                right: auto;
                transform: none;
                width: 90%;
                margin: 10px auto;
                flex-direction: row;
                flex-wrap: wrap;
                justify-content: center;
                padding: 10px;
            }
            
            .panel-title {
                width: 100%;
                margin-bottom: 10px;
            }
            
            .tool-type {
                flex-direction: row;
                width: auto;
            }
            
            .size-picker {
                width: auto;
                margin: 0 10px;
            }
            
            .btn {
                width: auto;
                margin: 5px;
            }
        }
        
        /* Animation for buttons */
        @keyframes bounce {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-5px);
            }
        }
        
        .bounce {
            animation: bounce 0.5s;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎨 Kid's Drawing Fun! 🖌️</h1>
        
        <div class="drawing-app">
            <!-- Left Panel -->
            <div class="left-panel">
                <div class="panel-title">Tools</div>
                <div class="tool-type">
                    <button class="tool-btn active" id="pen-btn">Pen ✏️</button>
                    <button class="tool-btn" id="shape-btn">Shapes 📐</button>
                    <button class="tool-btn" id="sticker-btn">Stickers 🌟</button>
                </div>
                
                <div class="size-picker">
                    <label for="brush-size">Size:</label>
                    <input type="range" id="brush-size" min="1" max="50" value="10">
                </div>
                
                <div class="color-picker">
                    <!-- Color options will be dynamically generated -->
                </div>
                
                <button class="btn btn-undo" id="undo-btn">↩️ Undo</button>
                <button class="btn btn-clear" id="clear-btn">🧹 Clear</button>
            </div>
            
            <!-- Right Panel -->
            <div class="right-panel">
                <div class="panel-title" id="right-panel-title">Stickers</div>
                
                <!-- Shapes options container -->
                <div class="shapes-container" style="display: none;">
                    <button class="tool-btn shape-btn" data-shape="rectangle">□</button>
                    <button class="tool-btn shape-btn" data-shape="circle">○</button>
                    <button class="tool-btn shape-btn" data-shape="triangle">△</button>
                    <button class="tool-btn shape-btn" data-shape="line">╱</button>
                    <button class="tool-btn shape-btn" data-shape="heart">♥</button>
                    <button class="tool-btn shape-btn" data-shape="star">★</button>
                </div>
                
                <!-- Stickers container -->
                <div class="stickers-container" style="display: none;">
                    <!-- Stickers will be dynamically generated -->
                </div>
                
                <div class="panel-title" style="margin-top: 10px;">Save</div>
                <input type="text" class="drawing-name-input" id="drawing-name" placeholder="My Masterpiece" style="width: 100%; margin-bottom: 5px;">
                <button class="btn btn-save" id="save-btn">💾 Save</button>
            </div>
            
            <div class="canvas-container">
                <canvas id="drawing-canvas" width="800" height="600"></canvas>
            </div>
            
            <h2 class="section-title">My Saved Drawings</h2>
            <div class="gallery" id="gallery">
                <!-- Saved drawings will appear here -->
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Canvas setup
            const canvas = document.getElementById('drawing-canvas');
            const ctx = canvas.getContext('2d');
            
            // App state
            let isDrawing = false;
            let lastX = 0;
            let lastY = 0;
            let startX = 0;
            let startY = 0;
            let brushSize = 10;
            let currentColor = '#ff6b6b';
            let drawingHistory = [];
            let currentTool = 'pen'; // 'pen', 'shape', or 'sticker'
            let selectedSticker = null;
            let selectedShape = null;
            let shapeDraft = null; // For preview while drawing shapes
            
            // Resize canvas to fit container on load
            function resizeCanvas() {
                const container = document.querySelector('.canvas-container');
                const containerWidth = container.clientWidth;
                // Keep aspect ratio 4:3
                const containerHeight = containerWidth * 0.75;
                
                canvas.width = containerWidth;
                canvas.height = containerHeight;
                
                // Restore the canvas content after resizing
                if (drawingHistory.length > 0) {
                    const lastState = drawingHistory[drawingHistory.length - 1];
                    const img = new Image();
                    img.onload = function() {
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    };
                    img.src = lastState;
                } else {
                    // Clear canvas with white background if there's no history
                    ctx.fillStyle = 'white';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                }
            }
            
            // Initialize canvas
            function initCanvas() {
                resizeCanvas();
                saveState(); // Save initial white state
                
                // Set white background
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }
            
            // Initialize colors
            function initColors() {
                const colorPicker = document.querySelector('.color-picker');
                const colors = [
                    '#ff6b6b', // Red
                    '#ff9f43', // Orange
                    '#feca57', // Yellow
                    '#1dd1a1', // Green
                    '#00d2d3', // Teal
                    '#54a0ff', // Blue
                    '#5f27cd', // Purple
                    '#ff9ff3', // Pink
                    '#222f3e', // Dark Blue
                    '#576574', // Gray
                    '#222222', // Black
                    '#ffffff'  // White
                ];
                
                colors.forEach(color => {
                    const colorOption = document.createElement('div');
                    colorOption.className = 'color-option';
                    colorOption.style.backgroundColor = color;
                    
                    if (color === currentColor) {
                        colorOption.classList.add('selected');
                    }
                    
                    colorOption.addEventListener('click', () => {
                        document.querySelectorAll('.color-option').forEach(option => {
                            option.classList.remove('selected');
                        });
                        colorOption.classList.add('selected');
                        currentColor = color;
                        
                        // Bounce animation
                        colorOption.classList.add('bounce');
                        setTimeout(() => {
                            colorOption.classList.remove('bounce');
                        }, 500);
                    });
                    
                    colorPicker.appendChild(colorOption);
                });
            }
            
            // Initialize stickers
            function initStickers() {
                const stickersContainer = document.querySelector('.stickers-container');
                
                // Define stickers as SVG
                const stickers = [
                    // Star
                    `<svg viewBox="0 0 50 50" fill="#FFD700">
                        <path d="M25 2.5l6.6 13.3 14.7 2.1-10.6 10.4 2.5 14.6L25 36.3l-13.2 6.9 2.5-14.6L3.7 18.2l14.7-2.1z"/>
                    </svg>`,
                    
                    // Heart
                    `<svg viewBox="0 0 50 50" fill="#FF6B6B">
                        <path d="M25 45.3l-3.5-3.2C8.7 30.7 0 23 0 13.5 0 6 5.9 0 13.3 0c4.1 0 8.1 1.9 10.7 5 2.6-3.1 6.6-5 10.7-5C42.1 0 48 6 48 13.5c0 9.5-8.7 17.2-21.5 28.6l-3.5 3.2z"/>
                    </svg>`,
                    
                    // Smiley
                    `<svg viewBox="0 0 50 50" fill="#FFC107">
                        <circle cx="25" cy="25" r="22" />
                        <circle cx="16" cy="20" r="3" fill="black" />
                        <circle cx="34" cy="20" r="3" fill="black" />
                        <path d="M15 32c0 0 5 5 10 5 5 0 10-5 10-5" stroke="black" stroke-width="2" fill="none" />
                    </svg>`,
                    
                    // Flower
                    `<svg viewBox="0 0 50 50">
                        <circle cx="25" cy="25" r="7" fill="#FF9FF3" />
                        <ellipse cx="25" cy="10" rx="8" ry="10" fill="#FF9FF3" />
                        <ellipse cx="25" cy="40" rx="8" ry="10" fill="#FF9FF3" />
                        <ellipse cx="10" cy="25" rx="10" ry="8" fill="#FF9FF3" />
                        <ellipse cx="40" cy="25" rx="10" ry="8" fill="#FF9FF3" />
                        <circle cx="25" cy="25" r="5" fill="#FECA57" />
                    </svg>`,
                    
                    // Butterfly
                    `<svg viewBox="0 0 50 50">
                        <path d="M25,15 C20,5 5,10 10,20 C15,30 25,30 25,30 C25,30 35,30 40,20 C45,10 30,5 25,15" fill="#54A0FF" />
                        <path d="M24,15 L26,35" stroke="#222" stroke-width="2" />
                    </svg>`,
                    
                    // Rainbow
                    `<svg viewBox="0 0 50 50">
                        <path d="M5,30 C5,15 25,5 45,30" stroke="#FF6B6B" stroke-width="3" fill="none" />
                        <path d="M10,30 C10,18 25,10 40,30" stroke="#FFC107" stroke-width="3" fill="none" />
                        <path d="M15,30 C15,21 25,15 35,30" stroke="#1DD1A1" stroke-width="3" fill="none" />
                        <path d="M20,30 C20,24 25,20 30,30" stroke="#54A0FF" stroke-width="3" fill="none" />
                    </svg>`,
                    
                    // Tree
                    `<svg viewBox="0 0 50 50">
                        <rect x="22" y="30" width="6" height="15" fill="#795548" />
                        <polygon points="25,5 10,30 40,30" fill="#1DD1A1" />
                    </svg>`,
                    
                    // Rocket
                    `<svg viewBox="0 0 50 50">
                        <path d="M20,45 L25,30 L30,45 Z" fill="#FF9F43" />
                        <path d="M15,20 C15,5 25,5 25,5 C25,5 35,5 35,20 C35,35 25,45 25,45 C25,45 15,35 15,20" fill="#54A0FF" />
                        <circle cx="25" cy="20" r="4" fill="white" />
                    </svg>`,
                    
                    // Sun
                    `<svg viewBox="0 0 50 50">
                        <circle cx="25" cy="25" r="10" fill="#FFC107" />
                        <line x1="25" y1="5" x2="25" y2="15" stroke="#FFC107" stroke-width="3" />
                        <line x1="25" y1="35" x2="25" y2="45" stroke="#FFC107" stroke-width="3" />
                        <line x1="5" y1="25" x2="15" y2="25" stroke="#FFC107" stroke-width="3" />
                        <line x1="35" y1="25" x2="45" y2="25" stroke="#FFC107" stroke-width="3" />
                        <line x1="12" y1="12" x2="18" y2="18" stroke="#FFC107" stroke-width="3" />
                        <line x1="32" y1="32" x2="38" y2="38" stroke="#FFC107" stroke-width="3" />
                        <line x1="12" y1="38" x2="18" y2="32" stroke="#FFC107" stroke-width="3" />
                        <line x1="32" y1="18" x2="38" y2="12" stroke="#FFC107" stroke-width="3" />
                    </svg>`,
                    
                    // Cloud
                    `<svg viewBox="0 0 50 50">
                        <path d="M10,25 C10,20 15,15 20,15 C25,10 35,15 35,20 C40,20 45,25 40,30 C40,35 30,35 25,35 C20,35 10,35 10,30 C5,30 5,25 10,25" fill="#E0E0E0" />
                    </svg>`
                ];
                
                stickers.forEach((stickerSvg, index) => {
                    const stickerDiv = document.createElement('div');
                    stickerDiv.className = 'sticker';
                    stickerDiv.innerHTML = stickerSvg;
                    stickerDiv.dataset.index = index;
                    
                    stickerDiv.addEventListener('click', function() {
                        document.querySelectorAll('.sticker').forEach(s => {
                            s.style.backgroundColor = '#f9f9f9';
                        });
                        this.style.backgroundColor = '#ddeeff';
                        selectedSticker = this.innerHTML;
                        
                        // Bounce animation
                        this.classList.add('bounce');
                        setTimeout(() => {
                            this.classList.remove('bounce');
                        }, 500);
                    });
                    
                    stickersContainer.appendChild(stickerDiv);
                });
            }
            
            // Drawing functions
            function startDrawing(e) {
                isDrawing = true;
                
                // Get position based on event type (mouse or touch)
                const pos = getEventPosition(e);
                lastX = pos.x;
                lastY = pos.y;
                startX = pos.x;
                startY = pos.y;
                
                if (currentTool === 'pen') {
                    // Nothing needed for pen, we'll draw on move
                } else if (currentTool === 'sticker' && selectedSticker) {
                    // Draw sticker at position
                    drawSticker(pos.x, pos.y);
                    saveState();
                } else if (currentTool === 'shape' && selectedShape) {
                    // For shapes, we'll draw on move to show preview
                    // Save the current canvas state for restoring while dragging
                    shapeDraft = canvas.toDataURL();
                }
            }
            
            function drawSticker(x, y) {
                const parser = new DOMParser();
                const svgDoc = parser.parseFromString(selectedSticker, 'image/svg+xml');
                const svgElement = svgDoc.documentElement;
                
                // Create image from SVG
                const svgString = new XMLSerializer().serializeToString(svgElement);
                const img = new Image();
                const svgBlob = new Blob([svgString], {type: 'image/svg+xml'});
                const url = URL.createObjectURL(svgBlob);
                
                img.onload = function() {
                    // Calculate sticker size based on brush size
                    const stickerSize = brushSize * 5;
                    ctx.drawImage(img, x - stickerSize/2, y - stickerSize/2, stickerSize, stickerSize);
                    URL.revokeObjectURL(url);
                    saveState();
                };
                
                img.src = url;
            }
            
            function draw(e) {
                if (!isDrawing) return;
                
                const pos = getEventPosition(e);
                
                if (currentTool === 'pen') {
                    ctx.beginPath();
                    ctx.lineCap = 'round';
                    ctx.lineJoin = 'round';
                    ctx.lineWidth = brushSize;
                    ctx.strokeStyle = currentColor;
                    
                    // Draw line
                    ctx.moveTo(lastX, lastY);
                    ctx.lineTo(pos.x, pos.y);
                    ctx.stroke();
                    
                    lastX = pos.x;
                    lastY = pos.y;
                } else if (currentTool === 'shape' && selectedShape) {
                    // Draw shape preview - first restore canvas
                    const img = new Image();
                    img.onload = function() {
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        
                        // Draw the shape preview
                        drawShape(startX, startY, pos.x, pos.y);
                    };
                    img.src = shapeDraft;
                }
            }
            
            function drawShape(startX, startY, endX, endY) {
                const width = endX - startX;
                const height = endY - startY;
                const size = Math.max(Math.abs(width), Math.abs(height));
                
                ctx.lineWidth = brushSize;
                ctx.strokeStyle = currentColor;
                ctx.fillStyle = currentColor;
                
                switch(selectedShape) {
                    case 'rectangle':
                        ctx.beginPath();
                        ctx.rect(startX, startY, width, height);
                        ctx.stroke();
                        break;
                    case 'circle':
                        ctx.beginPath();
                        // Use the distance from start to end as radius
                        const radius = Math.sqrt(width * width + height * height) / 2;
                        const centerX = startX + width / 2;
                        const centerY = startY + height / 2;
                        ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
                        ctx.stroke();
                        break;
                    case 'triangle':
                        ctx.beginPath();
                        ctx.moveTo(startX + width / 2, startY);
                        ctx.lineTo(startX, startY + height);
                        ctx.lineTo(startX + width, startY + height);
                        ctx.closePath();
                        ctx.stroke();
                        break;
                    case 'line':
                        ctx.beginPath();
                        ctx.moveTo(startX, startY);
                        ctx.lineTo(endX, endY);
                        ctx.stroke();
                        break;
                    case 'heart':
                        // Draw a heart shape
                        drawHeart(startX, startY, width, height);
                        break;
                    case 'star':
                        // Draw a star shape
                        drawStar(startX, startY, width, height);
                        break;
                }
            }
            
            function drawHeart(x, y, width, height) {
                const topCurveHeight = height * 0.3;
                
                ctx.beginPath();
                ctx.moveTo(x + width / 2, y + height);
                
                // Left side of heart
                ctx.bezierCurveTo(
                    x, y + height * 0.7, // Control point 1
                    x - width * 0.2, y + height * 0.5, // Control point 2
                    x + width / 2, y + topCurveHeight // End point
                );
                
                // Right side of heart
                ctx.bezierCurveTo(
                    x + width + width * 0.2, y + height * 0.5, // Control point 1
                    x + width, y + height * 0.7, // Control point 2
                    x + width / 2, y + height // End point
                );
                
                ctx.stroke();
            }
            
            function drawStar(x, y, width, height) {
                const outerRadius = Math.min(Math.abs(width), Math.abs(height)) / 2;
                const innerRadius = outerRadius / 2.5;
                const centerX = x + width / 2;
                const centerY = y + height / 2;
                const spikes = 5;
                const rotation = Math.PI / 2 * 3;
                
                let step = Math.PI / spikes;
                
                ctx.beginPath();
                ctx.moveTo(centerX, centerY - outerRadius);
                
                for (let i = 0; i < spikes; i++) {
                    let outerX = centerX + Math.cos(rotation + i * step * 2) * outerRadius;
                    let outerY = centerY + Math.sin(rotation + i * step * 2) * outerRadius;
                    ctx.lineTo(outerX, outerY);
                    
                    let innerX = centerX + Math.cos(rotation + i * step * 2 + step) * innerRadius;
                    let innerY = centerY + Math.sin(rotation + i * step * 2 + step) * innerRadius;
                    ctx.lineTo(innerX, innerY);
                }
                
                ctx.closePath();
                ctx.stroke();
            }
            
            function stopDrawing() {
                if (!isDrawing) return;
                
                if (currentTool === 'pen') {
                    saveState();
                } else if (currentTool === 'shape' && selectedShape) {
                    saveState();
                }
                
                isDrawing = false;
                shapeDraft = null;
            }
            
            // Utility function to get position from mouse or touch event
            function getEventPosition(e) {
                let x, y;
                
                if (e.type.includes('touch')) {
                    const rect = canvas.getBoundingClientRect();
                    const touch = e.touches[0] || e.changedTouches[0];
                    x = touch.clientX - rect.left;
                    y = touch.clientY - rect.top;
                } else {
                    const rect = canvas.getBoundingClientRect();
                    x = e.clientX - rect.left;
                    y = e.clientY - rect.top;
                }
                
                return { x, y };
            }
            
            // Save current state to history
            function saveState() {
                // Limit history to prevent memory issues
                if (drawingHistory.length >= 20) {
                    drawingHistory.shift();
                }
                
                drawingHistory.push(canvas.toDataURL());
            }
            
            // Undo last action
            function undo() {
                if (drawingHistory.length > 1) {
                    // Remove current state
                    drawingHistory.pop();
                    
                    // Load previous state
                    const previousState = drawingHistory[drawingHistory.length - 1];
                    const img = new Image();
                    img.onload = function() {
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    };
                    img.src = previousState;
                } else {
                    // Clear canvas if no history left
                    clearCanvas();
                }
            }
            
            // Clear canvas
            function clearCanvas() {
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Reset history
                drawingHistory = [];
                saveState();
            }
            
            // Save drawing
            function saveDrawing() {
                const drawingName = document.getElementById('drawing-name').value || 'My Drawing';
                const drawingData = canvas.toDataURL();
                
                // Get existing drawings or initialize empty array
                let savedDrawings = JSON.parse(localStorage.getItem('kidDrawings') || '[]');
                
                // Add new drawing
                savedDrawings.push({
                    name: drawingName,
                    data: drawingData,
                    date: new Date().toISOString()
                });
                
                // Save back to localStorage
                localStorage.setItem('kidDrawings', JSON.stringify(savedDrawings));
                
                // Refresh gallery
                loadGallery();
                
                // Show success animation
                const saveBtn = document.getElementById('save-btn');
                saveBtn.classList.add('bounce');
                saveBtn.textContent = '✅ Saved!';
                
                setTimeout(() => {
                    saveBtn.classList.remove('bounce');
                    saveBtn.textContent = '💾 Save';
                }, 1500);
            }
            
            // Load saved drawings gallery
            function loadGallery() {
                const gallery = document.getElementById('gallery');
                gallery.innerHTML = '';
                
                // Get saved drawings
                const savedDrawings = JSON.parse(localStorage.getItem('kidDrawings') || '[]');
                
                if (savedDrawings.length === 0) {
                    gallery.innerHTML = '<p style="text-align:center;width:100%;color:#888;padding:20px;">No saved drawings yet. Create your masterpiece and save it!</p>';
                    return;
                }
                
                savedDrawings.forEach((drawing, index) => {
                    const drawingElement = document.createElement('div');
                    drawingElement.className = 'saved-drawing';
                    drawingElement.title = drawing.name;
                    drawingElement.style.backgroundImage = `url(${drawing.data})`;
                    drawingElement.style.backgroundSize = 'cover';
                    drawingElement.style.backgroundPosition = 'center';
                    
                    // Delete button
                    const deleteBtn = document.createElement('div');
                    deleteBtn.className = 'delete-drawing';
                    deleteBtn.innerHTML = '✕';
                    deleteBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        deleteDrawing(index);
                    });
                    
                    // Load drawing when clicked
                    drawingElement.addEventListener('click', () => {
                        loadDrawing(drawing.data);
                    });
                    
                    drawingElement.appendChild(deleteBtn);
                    gallery.appendChild(drawingElement);
                });
            }
            
            // Load a drawing onto canvas
            function loadDrawing(drawingData) {
                const img = new Image();
                img.onload = function() {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    saveState();
                };
                img.src = drawingData;
            }
            
            // Delete a drawing
            function deleteDrawing(index) {
                if (confirm('Are you sure you want to delete this drawing?')) {
                    let savedDrawings = JSON.parse(localStorage.getItem('kidDrawings') || '[]');
                    savedDrawings.splice(index, 1);
                    localStorage.setItem('kidDrawings', JSON.stringify(savedDrawings));
                    loadGallery();
                }
            }
            
            // Initialize shape buttons
            function initShapeButtons() {
                const shapeButtons = document.querySelectorAll('.shape-btn');
                
                shapeButtons.forEach(btn => {
                    btn.addEventListener('click', function() {
                        // Clear previously selected shape
                        shapeButtons.forEach(b => b.classList.remove('selected'));
                        
                        // Set new selected shape
                        this.classList.add('selected');
                        selectedShape = this.dataset.shape;
                        
                        // Bounce animation
                        this.classList.add('bounce');
                        setTimeout(() => {
                            this.classList.remove('bounce');
                        }, 500);
                    });
                });
                
                // Select rectangle by default
                if (shapeButtons.length > 0) {
                    shapeButtons[0].classList.add('selected');
                    selectedShape = 'rectangle';
                }
            }
            
            // Tool selection
            document.getElementById('pen-btn').addEventListener('click', function() {
                currentTool = 'pen';
                
                // Update tool buttons
                document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');
                
                // Show/hide appropriate containers
                document.querySelector('.stickers-container').style.display = 'none';
                document.querySelector('.shapes-container').style.display = 'none';
                document.querySelector('.color-picker').style.display = 'flex';
                
                // Update right panel title
                document.getElementById('right-panel-title').textContent = 'Colors';
                
                canvas.style.cursor = 'crosshair';
            });
            
            document.getElementById('shape-btn').addEventListener('click', function() {
                currentTool = 'shape';
                
                // Update tool buttons
                document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');
                
                // Show/hide appropriate containers
                document.querySelector('.stickers-container').style.display = 'none';
                document.querySelector('.shapes-container').style.display = 'flex';
                document.querySelector('.color-picker').style.display = 'flex';
                
                // Update right panel title
                document.getElementById('right-panel-title').textContent = 'Shapes';
                
                canvas.style.cursor = 'crosshair';
            });
            
            document.getElementById('sticker-btn').addEventListener('click', function() {
                currentTool = 'sticker';
                
                // Update tool buttons
                document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');
                
                // Show/hide appropriate containers
                document.querySelector('.stickers-container').style.display = 'flex';
                document.querySelector('.shapes-container').style.display = 'none';
                document.querySelector('.color-picker').style.display = 'none';
                
                // Update right panel title
                document.getElementById('right-panel-title').textContent = 'Stickers';
                
                canvas.style.cursor = 'pointer';
            });
            
            // Event listeners
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            
            // Touch support
            canvas.addEventListener('touchstart', function(e) {
                e.preventDefault();
                startDrawing(e);
            });
            canvas.addEventListener('touchmove', function(e) {
                e.preventDefault();
                draw(e);
            });
            canvas.addEventListener('touchend', stopDrawing);
            
            // Button actions
            document.getElementById('undo-btn').addEventListener('click', undo);
            document.getElementById('clear-btn').addEventListener('click', function() {
                if (confirm('Are you sure you want to clear your drawing?')) {
                    clearCanvas();
                    this.classList.add('bounce');
                    setTimeout(() => {
                        this.classList.remove('bounce');
                    }, 500);
                }
            });
            document.getElementById('save-btn').addEventListener('click', saveDrawing);
            
            // Brush size slider
            document.getElementById('brush-size').addEventListener('input', function() {
                brushSize = this.value;
            });
            
            // Window resize handling
            window.addEventListener('resize', resizeCanvas);
            
            // Initialize
            initCanvas();
            initColors();
            initStickers();
            initShapeButtons();
            loadGallery();
        });
    </script>
</body>
</html>
