<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Colorful Kids Drawing App</title>
    <style>
        /* CSS Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Comic Sans MS', cursive, sans-serif;
        }
        
        body {
            background-color: #f0f8ff;
            overflow-x: hidden;
        }
        
        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1 {
            color: #ff6b6b;
            text-align: center;
            margin-bottom: 10px;
            font-size: 2rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        
        .drawing-app {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            position: relative;
            margin-top: 10px;
        }
        
        .canvas-container {
            position: relative;
            border: 6px solid #ffcc5c;
            border-radius: 10px;
            margin: 10px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            background-color: white;
            overflow: hidden;
            width: calc(100% - 180px); /* Account for side panels */
            max-width: 800px;
        }
        
        #drawing-canvas {
            display: block;
            cursor: crosshair;
            background-color: white;
            touch-action: none;
            width: 100%;
            height: auto;
        }
        
        .tools {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
            width: 100%;
        }
        
        .left-panel, .right-panel {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 75px;
            background-color: white;
            border-radius: 10px;
            padding: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 10;
        }
        
        .left-panel {
            left: 5px;
        }
        
        .right-panel {
            right: 5px;
        }
        
        .panel-title {
            font-size: 0.9rem;
            font-weight: bold;
            color: #333;
            text-align: center;
            margin-bottom: 5px;
            border-bottom: 2px dashed #ddd;
            padding-bottom: 5px;
        }
        
        .color-picker {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .color-option {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.2s;
            border: 3px solid #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .color-option:hover {
            transform: scale(1.1);
        }
        
        .color-option.selected {
            border: 3px solid #333;
            transform: scale(1.1);
        }
        
        .btn {
            padding: 10px;
            border: none;
            border-radius: 25px;
            background-color: #74b9ff;
            color: white;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        
        .btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .btn-undo {
            background-color: #ff9f43;
        }
        
        .btn-clear {
            background-color: #ff6b6b;
        }
        
        .btn-save {
            background-color: #10ac84;
        }
        
        .stickers-container, .shapes-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 5px;
            max-width: 70px;
        }
        
        .sticker {
            width: 36px;
            height: 36px;
            cursor: pointer;
            transition: transform 0.2s;
            background-color: #f9f9f9;
            border-radius: 8px;
            padding: 2px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px; /* Size for emoji */
            line-height: 1;
        }
        
        .sticker:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .sticker.selected, .shape-btn.selected {
            background-color: #ddeeff;
            transform: scale(1.1);
            border: 2px solid #74b9ff;
        }
        
        .shape-btn {
            width: 30px;
            height: 30px;
            font-size: 18px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .size-picker {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 10px;
            background-color: white;
            padding: 5px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .size-picker label {
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
            font-size: 0.8rem;
        }
        
        .size-picker input {
            width: 100%;
        }
        
        .tool-type {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-bottom: 10px;
        }
        
        .tool-btn {
            padding: 8px 5px;
            border: none;
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s;
            background-color: #ddd;
            color: #333;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .tool-btn.active {
            background-color: #74b9ff;
            color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .gallery {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
            background-color: rgba(255, 255, 255, 0.7);
            border-radius: 10px;
        }
        
        .saved-drawing {
            width: 120px;
            height: 90px;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: transform 0.2s;
            position: relative;
        }
        
        .saved-drawing:hover {
            transform: scale(1.05);
        }
        
        .delete-drawing {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ff6b6b;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
            font-weight: bold;
            border: 2px solid white;
        }
        
        .saved-drawing:hover .delete-drawing {
            opacity: 1;
        }
        
        .section-title {
            font-size: 1.5rem;
            color: #333;
            margin: 15px 0 10px;
            text-align: center;
            width: 100%;
        }
        
        .drawing-name-input {
            padding: 10px 15px;
            border: 2px solid #74b9ff;
            border-radius: 25px;
            font-size: 1rem;
            margin-bottom: 15px;
            width: 250px;
            text-align: center;
        }
        
        @media (max-width: 768px) {
            .tools {
                flex-direction: column;
                align-items: center;
            }
            
            .container {
                padding: 5px;
            }
            
            h1 {
                font-size: 1.5rem;
                margin-bottom: 5px;
            }
            
            .canvas-container {
                width: 95%;
                max-width: 95vw;
                margin: 0 auto;
                border-width: 4px;
            }
            
            #drawing-canvas {
                width: 100%;
                height: auto;
            }
            
            .color-picker, .stickers-container, .shapes-container {
                max-width: 95%;
                gap: 8px;
            }
            
            .left-panel, .right-panel {
                position: static;
                top: auto;
                left: auto;
                right: auto;
                transform: none;
                width: 95%;
                margin: 5px auto;
                flex-direction: row;
                flex-wrap: wrap;
                justify-content: center;
                padding: 8px;
                box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            }
            
            .panel-title {
                width: 100%;
                margin-bottom: 5px;
                font-size: 0.8rem;
            }
            
            .tool-type {
                flex-direction: row;
                width: 100%;
                justify-content: space-between;
                margin-bottom: 5px;
            }
            
            .size-picker {
                width: 100%;
                margin: 5px 0;
            }
            
            .btn {
                width: auto;
                margin: 3px;
                padding: 8px;
                font-size: 0.8rem;
            }
            
            .tool-btn {
                padding: 6px 10px;
                font-size: 0.8rem;
            }
            
            .color-option {
                width: 25px;
                height: 25px;
            }
            
            .sticker, .shape-btn {
                width: 28px;
                height: 28px;
            }
            
            .drawing-name-input {
                width: 100%;
                padding: 8px;
                font-size: 0.9rem;
            }
            
            .saved-drawing {
                width: 100px;
                height: 75px;
            }
            
            .gallery {
                max-height: 150px;
                padding: 5px;
                gap: 8px;
            }
            
            .section-title {
                font-size: 1.2rem;
                margin: 10px 0 5px;
            }
        }
        
        /* Extra small devices */
        @media (max-width: 480px) {
            h1 {
                font-size: 1.2rem;
            }
            
            .canvas-container {
                width: 98%;
                border-width: 3px;
            }
            
            .color-option {
                width: 22px;
                height: 22px;
            }
            
            .sticker, .shape-btn {
                width: 24px;
                height: 24px;
            }
            
            .btn {
                padding: 6px;
                font-size: 0.7rem;
            }
            
            .saved-drawing {
                width: 80px;
                height: 60px;
            }
        }
        
        /* Animation for buttons */
        @keyframes bounce {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-5px);
            }
        }
        
        .bounce {
            animation: bounce 0.5s;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé® Kid's Drawing Fun! üñåÔ∏è</h1>
        
        <div class="drawing-app">
            <!-- Left Panel -->
            <div class="left-panel">
                <div class="panel-title">Tools</div>
                <div class="tool-type">
                    <button class="tool-btn active" id="pen-btn">Pen ‚úèÔ∏è</button>
                    <button class="tool-btn" id="shape-btn">Shapes üìê</button>
                    <button class="tool-btn" id="sticker-btn">Stickers üåü</button>
                    <button class="tool-btn" id="fill-btn">Fill ü™£</button>
                </div>
                
                <div class="size-picker">
                    <label for="brush-size">Size:</label>
                    <input type="range" id="brush-size" min="1" max="50" value="10">
                </div>
                
                <div class="color-picker">
                    <!-- Color options will be dynamically generated -->
                </div>
            </div>
            
            <!-- Right Panel -->
            <div class="right-panel">
                <div class="panel-title" id="right-panel-title">Stickers</div>
                
                <!-- Shapes options container -->
                <div class="shapes-container" style="display: none;">
                    <button class="tool-btn shape-btn" data-shape="rectangle">‚ñ°</button>
                    <button class="tool-btn shape-btn" data-shape="circle">‚óã</button>
                    <button class="tool-btn shape-btn" data-shape="triangle">‚ñ≥</button>
                    <button class="tool-btn shape-btn" data-shape="line">‚ï±</button>
                    <button class="tool-btn shape-btn" data-shape="heart">‚ô•</button>
                    <button class="tool-btn shape-btn" data-shape="star">‚òÖ</button>
                </div>
                
                <!-- Stickers container -->
                <div class="stickers-container" style="display: none;">
                    <!-- Stickers will be dynamically generated -->
                </div>
                
                <div class="panel-title" style="margin-top: 10px;">Actions</div>
                <button class="btn btn-undo" id="undo-btn">‚Ü©Ô∏è Undo</button>
                <button class="btn btn-redo" id="redo-btn">‚Ü™Ô∏è Redo</button>
                <button class="btn btn-clear" id="clear-btn">üßπ Clear</button>
                
                <div class="panel-title" style="margin-top: 10px;">Save</div>
                <input type="text" class="drawing-name-input" id="drawing-name" placeholder="My Masterpiece" style="width: 100%; margin-bottom: 5px;">
                <button class="btn btn-save" id="save-btn">üíæ Save</button>
            </div>
            
            <div class="canvas-container">
                <canvas id="drawing-canvas" width="800" height="600"></canvas>
            </div>
            
            <h2 class="section-title">My Saved Drawings</h2>
            <div class="gallery" id="gallery">
                <!-- Saved drawings will appear here -->
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Canvas setup
            const canvas = document.getElementById('drawing-canvas');
            const ctx = canvas.getContext('2d');
            
            // App state
            let isDrawing = false;
            let lastX = 0;
            let lastY = 0;
            let startX = 0;
            let startY = 0;
            let brushSize = 10;
            let currentColor = '#ff6b6b';
            let drawingHistory = [];
            let redoHistory = [];
            let currentTool = 'pen'; // 'pen', 'shape', 'sticker', or 'fill'
            let selectedSticker = null;
            let selectedShape = null;
            let shapeDraft = null; // For preview while drawing shapes
            
            // Resize canvas to fit container on load
            function resizeCanvas() {
                const container = document.querySelector('.canvas-container');
                const containerWidth = container.clientWidth;
                // Keep aspect ratio 4:3
                const containerHeight = containerWidth * 0.75;
                
                // Store current content
                let currentDrawing = null;
                if (drawingHistory.length > 0) {
                    currentDrawing = drawingHistory[drawingHistory.length - 1];
                }
                
                // Update canvas size
                canvas.width = containerWidth;
                canvas.height = containerHeight;
                
                // Restore the canvas content after resizing
                if (currentDrawing) {
                    const img = new Image();
                    img.onload = function() {
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        ctx.fillStyle = 'white';
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    };
                    img.src = currentDrawing;
                } else {
                    // Clear canvas with white background if there's no history
                    ctx.fillStyle = 'white';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    saveState(); // Initialize history with blank canvas
                }
                
                // Log for debugging
                console.log(`Canvas resized to ${canvas.width}x${canvas.height}`);
            }
            
            // Initialize canvas
            function initCanvas() {
                resizeCanvas();
                saveState(); // Save initial white state
                
                // Set white background
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }
            
            // Initialize colors
            function initColors() {
                const colorPicker = document.querySelector('.color-picker');
                const colors = [
                    '#ff6b6b', // Red
                    '#ff9f43', // Orange
                    '#feca57', // Yellow
                    '#1dd1a1', // Green
                    '#00d2d3', // Teal
                    '#54a0ff', // Blue
                    '#5f27cd', // Purple
                    '#ff9ff3', // Pink
                    '#222f3e', // Dark Blue
                    '#576574', // Gray
                    '#222222', // Black
                    '#ffffff'  // White
                ];
                
                colors.forEach(color => {
                    const colorOption = document.createElement('div');
                    colorOption.className = 'color-option';
                    colorOption.style.backgroundColor = color;
                    
                    if (color === currentColor) {
                        colorOption.classList.add('selected');
                    }
                    
                    colorOption.addEventListener('click', () => {
                        document.querySelectorAll('.color-option').forEach(option => {
                            option.classList.remove('selected');
                        });
                        colorOption.classList.add('selected');
                        currentColor = color;
                        
                        // Bounce animation
                        colorOption.classList.add('bounce');
                        setTimeout(() => {
                            colorOption.classList.remove('bounce');
                        }, 500);
                    });
                    
                    colorPicker.appendChild(colorOption);
                });
            }
            
            // Initialize stickers
            function initStickers() {
                const stickersContainer = document.querySelector('.stickers-container');
                
                // Define stickers as emojis
                const stickers = [
                    "‚≠ê", // Star
                    "‚ù§Ô∏è", // Heart
                    "üòä", // Smiley
                    "üå∏", // Flower
                    "ü¶ã", // Butterfly
                    "üåà", // Rainbow
                    "üå≤", // Tree
                    "üöÄ", // Rocket
                    "‚òÄÔ∏è", // Sun
                    "‚òÅÔ∏è", // Cloud
                    "üåô", // Moon
                    "üê±", // Cat
                    "üê∂", // Dog
                    "üê¨", // Dolphin
                    "ü¶Ñ", // Unicorn
                    "üçï"  // Pizza
                ];
                
                stickers.forEach((emoji, index) => {
                    const stickerDiv = document.createElement('div');
                    stickerDiv.className = 'sticker';
                    stickerDiv.textContent = emoji;
                    stickerDiv.dataset.index = index;
                    stickerDiv.dataset.emoji = emoji; // Store emoji directly in dataset
                    
                    stickerDiv.addEventListener('click', function() {
                        // Deselect all stickers
                        document.querySelectorAll('.sticker').forEach(s => {
                            s.classList.remove('selected');
                            s.style.backgroundColor = '#f9f9f9';
                        });
                        
                        // Select this sticker
                        this.classList.add('selected');
                        this.style.backgroundColor = '#ddeeff';
                        selectedSticker = this.dataset.emoji; // Use the stored emoji
                        
                        // Bounce animation
                        this.classList.add('bounce');
                        setTimeout(() => {
                            this.classList.remove('bounce');
                        }, 500);
                    });
                    
                    stickersContainer.appendChild(stickerDiv);
                });
            }
            
            // Drawing functions
            function startDrawing(e) {
                isDrawing = true;
                
                // Get position based on event type (mouse or touch)
                const pos = getEventPosition(e);
                lastX = pos.x;
                lastY = pos.y;
                startX = pos.x;
                startY = pos.y;
                
                if (currentTool === 'pen') {
                    // Nothing needed for pen, we'll draw on move
                } else if (currentTool === 'sticker' && selectedSticker) {
                    // Draw sticker at position
                    drawSticker(pos.x, pos.y);
                    saveState();
                } else if (currentTool === 'shape' && selectedShape) {
                    // For shapes, we'll draw on move to show preview
                    // Save the current canvas state for restoring while dragging
                    shapeDraft = canvas.toDataURL();
                } else if (currentTool === 'fill') {
                    // Use the bucket fill tool
                    fillArea(Math.floor(pos.x), Math.floor(pos.y), currentColor);
                    saveState();
                }
            }
            
            // Bucket fill tool implementation
            function fillArea(startX, startY, fillColor) {
                // Get canvas pixel data
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;
                
                // Get the color at the clicked position
                const targetColor = getColorAtPixel(imageData, startX, startY);
                
                // Convert the fill color from hex to rgba
                const fillColorRgba = hexToRgba(fillColor);
                
                // Don't fill if target color is the same as fill color
                if (colorMatch(targetColor, fillColorRgba)) {
                    return;
                }
                
                // Stack-based flood fill (non-recursive to avoid stack overflow)
                const pixelsToCheck = [{x: startX, y: startY}];
                const visited = new Set();
                const width = canvas.width;
                const height = canvas.height;
                
                while (pixelsToCheck.length > 0) {
                    const {x, y} = pixelsToCheck.pop();
                    
                    // Skip if out of bounds or already visited
                    if (x < 0 || y < 0 || x >= width || y >= height || visited.has(`${x},${y}`)) {
                        continue;
                    }
                    
                    // Check if current pixel matches target color
                    const currentColor = getColorAtPixel(imageData, x, y);
                    if (!colorMatch(currentColor, targetColor)) {
                        continue;
                    }
                    
                    // Fill the pixel
                    setColorAtPixel(imageData, x, y, fillColorRgba);
                    visited.add(`${x},${y}`);
                    
                    // Add neighboring pixels to check
                    pixelsToCheck.push({x: x + 1, y: y});
                    pixelsToCheck.push({x: x - 1, y: y});
                    pixelsToCheck.push({x: x, y: y + 1});
                    pixelsToCheck.push({x: x, y: y - 1});
                }
                
                // Put the modified pixels back on the canvas
                ctx.putImageData(imageData, 0, 0);
                console.log("Fill operation completed");
            }
            
            // Helper function to get color at a specific pixel
            function getColorAtPixel(imageData, x, y) {
                const {width, data} = imageData;
                const index = (y * width + x) * 4;
                return {
                    r: data[index],
                    g: data[index + 1],
                    b: data[index + 2],
                    a: data[index + 3]
                };
            }
            
            // Helper function to set color at a specific pixel
            function setColorAtPixel(imageData, x, y, color) {
                const {width, data} = imageData;
                const index = (y * width + x) * 4;
                data[index] = color.r;
                data[index + 1] = color.g;
                data[index + 2] = color.b;
                data[index + 3] = color.a;
            }
            
            // Helper function to check if two colors match (with tolerance)
            function colorMatch(color1, color2, tolerance = 10) {
                return Math.abs(color1.r - color2.r) <= tolerance &&
                    Math.abs(color1.g - color2.g) <= tolerance &&
                    Math.abs(color1.b - color2.b) <= tolerance &&
                    Math.abs(color1.a - color2.a) <= tolerance;
            }
            
            // Helper function to convert hex color to rgba
            function hexToRgba(hex) {
                let r = 0, g = 0, b = 0, a = 255;
                
                // Remove the # if present
                if (hex.startsWith('#')) {
                    hex = hex.slice(1);
                }
                
                // Parse the hex values
                if (hex.length === 3) {
                    r = parseInt(hex[0] + hex[0], 16);
                    g = parseInt(hex[1] + hex[1], 16);
                    b = parseInt(hex[2] + hex[2], 16);
                } else if (hex.length >= 6) {
                    r = parseInt(hex.slice(0, 2), 16);
                    g = parseInt(hex.slice(2, 4), 16);
                    b = parseInt(hex.slice(4, 6), 16);
                }
                
                return {r, g, b, a};
            }
            
            function drawSticker(x, y) {
                if (!selectedSticker) {
                    console.log("No sticker selected");
                    return;
                }
                
                try {
                    // Calculate emoji size based on brush size
                    const fontSize = brushSize * 3; // Adjust this multiplier as needed
                    
                    // Set font style
                    ctx.font = `${fontSize}px Arial`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    
                    // Draw the emoji directly to canvas
                    ctx.fillText(selectedSticker, x, y);
                    console.log("Sticker drawn successfully:", selectedSticker);
                    
                    // Save state after drawing
                    saveState();
                } catch (e) {
                    console.error("Error drawing sticker:", e);
                }
            }
            
            function draw(e) {
                if (!isDrawing) return;
                
                const pos = getEventPosition(e);
                
                if (currentTool === 'pen') {
                    ctx.beginPath();
                    ctx.lineCap = 'round';
                    ctx.lineJoin = 'round';
                    ctx.lineWidth = brushSize;
                    ctx.strokeStyle = currentColor;
                    
                    // Draw line
                    ctx.moveTo(lastX, lastY);
                    ctx.lineTo(pos.x, pos.y);
                    ctx.stroke();
                    
                    lastX = pos.x;
                    lastY = pos.y;
                } else if (currentTool === 'shape' && selectedShape) {
                    // Draw shape preview - first restore canvas
                    const img = new Image();
                    img.onload = function() {
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        
                        // Draw the shape preview
                        drawShape(startX, startY, pos.x, pos.y);
                    };
                    img.src = shapeDraft;
                }
            }
            
            function drawShape(startX, startY, endX, endY) {
                const width = endX - startX;
                const height = endY - startY;
                const size = Math.max(Math.abs(width), Math.abs(height));
                
                ctx.lineWidth = brushSize;
                ctx.strokeStyle = currentColor;
                ctx.fillStyle = currentColor;
                
                switch(selectedShape) {
                    case 'rectangle':
                        ctx.beginPath();
                        ctx.rect(startX, startY, width, height);
                        ctx.stroke();
                        break;
                    case 'circle':
                        ctx.beginPath();
                        // Use the distance from start to end as radius
                        const radius = Math.sqrt(width * width + height * height) / 2;
                        const centerX = startX + width / 2;
                        const centerY = startY + height / 2;
                        ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
                        ctx.stroke();
                        break;
                    case 'triangle':
                        ctx.beginPath();
                        ctx.moveTo(startX + width / 2, startY);
                        ctx.lineTo(startX, startY + height);
                        ctx.lineTo(startX + width, startY + height);
                        ctx.closePath();
                        ctx.stroke();
                        break;
                    case 'line':
                        ctx.beginPath();
                        ctx.moveTo(startX, startY);
                        ctx.lineTo(endX, endY);
                        ctx.stroke();
                        break;
                    case 'heart':
                        // Draw a heart shape
                        drawHeart(startX, startY, width, height);
                        break;
                    case 'star':
                        // Draw a star shape
                        drawStar(startX, startY, width, height);
                        break;
                }
            }
            
            function drawHeart(x, y, width, height) {
                const topCurveHeight = height * 0.3;
                
                ctx.beginPath();
                ctx.moveTo(x + width / 2, y + height);
                
                // Left side of heart
                ctx.bezierCurveTo(
                    x, y + height * 0.7, // Control point 1
                    x - width * 0.2, y + height * 0.5, // Control point 2
                    x + width / 2, y + topCurveHeight // End point
                );
                
                // Right side of heart
                ctx.bezierCurveTo(
                    x + width + width * 0.2, y + height * 0.5, // Control point 1
                    x + width, y + height * 0.7, // Control point 2
                    x + width / 2, y + height // End point
                );
                
                ctx.stroke();
            }
            
            function drawStar(x, y, width, height) {
                const outerRadius = Math.min(Math.abs(width), Math.abs(height)) / 2;
                const innerRadius = outerRadius / 2.5;
                const centerX = x + width / 2;
                const centerY = y + height / 2;
                const spikes = 5;
                const rotation = Math.PI / 2 * 3;
                
                let step = Math.PI / spikes;
                
                ctx.beginPath();
                ctx.moveTo(centerX, centerY - outerRadius);
                
                for (let i = 0; i < spikes; i++) {
                    let outerX = centerX + Math.cos(rotation + i * step * 2) * outerRadius;
                    let outerY = centerY + Math.sin(rotation + i * step * 2) * outerRadius;
                    ctx.lineTo(outerX, outerY);
                    
                    let innerX = centerX + Math.cos(rotation + i * step * 2 + step) * innerRadius;
                    let innerY = centerY + Math.sin(rotation + i * step * 2 + step) * innerRadius;
                    ctx.lineTo(innerX, innerY);
                }
                
                ctx.closePath();
                ctx.stroke();
            }
            
            function stopDrawing() {
                if (!isDrawing) return;
                
                if (currentTool === 'pen') {
                    saveState();
                } else if (currentTool === 'shape' && selectedShape) {
                    saveState();
                }
                
                isDrawing = false;
                shapeDraft = null;
            }
            
            // Utility function to get position from mouse or touch event
            function getEventPosition(e) {
                let x, y;
                
                if (e.type.includes('touch')) {
                    const rect = canvas.getBoundingClientRect();
                    const touch = e.touches[0] || e.changedTouches[0];
                    x = touch.clientX - rect.left;
                    y = touch.clientY - rect.top;
                } else {
                    const rect = canvas.getBoundingClientRect();
                    x = e.clientX - rect.left;
                    y = e.clientY - rect.top;
                }
                
                return { x, y };
            }
            
            // Save current state to history
            function saveState() {
                // Clear redo history when a new state is created
                redoHistory = [];
                
                // Limit history to prevent memory issues
                if (drawingHistory.length >= 20) {
                    drawingHistory.shift();
                }
                
                drawingHistory.push(canvas.toDataURL());
            }
            
            // Undo last action
            function undo() {
                if (drawingHistory.length > 1) {
                    // Save current state to redo history
                    redoHistory.push(drawingHistory.pop());
                    
                    // Load previous state
                    const previousState = drawingHistory[drawingHistory.length - 1];
                    const img = new Image();
                    img.onload = function() {
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    };
                    img.src = previousState;
                } else {
                    // Clear canvas if no history left
                    clearCanvas();
                }
            }
            
            // Redo last undone action
            function redo() {
                if (redoHistory.length > 0) {
                    // Get the last undone state
                    const nextState = redoHistory.pop();
                    
                    // Add it back to the drawing history
                    drawingHistory.push(nextState);
                    
                    // Load the state onto the canvas
                    const img = new Image();
                    img.onload = function() {
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    };
                    img.src = nextState;
                }
            }
            
            // Clear canvas
            function clearCanvas() {
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Reset history
                drawingHistory = [];
                saveState();
            }
            
            // Save drawing
            function saveDrawing() {
                const drawingName = document.getElementById('drawing-name').value || 'My Drawing';
                const drawingData = canvas.toDataURL();
                
                // Get existing drawings or initialize empty array
                let savedDrawings = JSON.parse(localStorage.getItem('kidDrawings') || '[]');
                
                // Add new drawing
                savedDrawings.push({
                    name: drawingName,
                    data: drawingData,
                    date: new Date().toISOString()
                });
                
                // Save back to localStorage
                localStorage.setItem('kidDrawings', JSON.stringify(savedDrawings));
                
                // Refresh gallery
                loadGallery();
                
                // Show success animation
                const saveBtn = document.getElementById('save-btn');
                saveBtn.classList.add('bounce');
                saveBtn.textContent = '‚úÖ Saved!';
                
                setTimeout(() => {
                    saveBtn.classList.remove('bounce');
                    saveBtn.textContent = 'üíæ Save';
                }, 1500);
            }
            
            // Load saved drawings gallery
            function loadGallery() {
                const gallery = document.getElementById('gallery');
                gallery.innerHTML = '';
                
                // Get saved drawings
                const savedDrawings = JSON.parse(localStorage.getItem('kidDrawings') || '[]');
                
                if (savedDrawings.length === 0) {
                    gallery.innerHTML = '<p style="text-align:center;width:100%;color:#888;padding:20px;">No saved drawings yet. Create your masterpiece and save it!</p>';
                    return;
                }
                
                savedDrawings.forEach((drawing, index) => {
                    const drawingElement = document.createElement('div');
                    drawingElement.className = 'saved-drawing';
                    drawingElement.title = drawing.name;
                    drawingElement.style.backgroundImage = `url(${drawing.data})`;
                    drawingElement.style.backgroundSize = 'cover';
                    drawingElement.style.backgroundPosition = 'center';
                    
                    // Delete button
                    const deleteBtn = document.createElement('div');
                    deleteBtn.className = 'delete-drawing';
                    deleteBtn.innerHTML = '‚úï';
                    deleteBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        deleteDrawing(index);
                    });
                    
                    // Load drawing when clicked
                    drawingElement.addEventListener('click', () => {
                        loadDrawing(drawing.data);
                    });
                    
                    drawingElement.appendChild(deleteBtn);
                    gallery.appendChild(drawingElement);
                });
            }
            
            // Load a drawing onto canvas
            function loadDrawing(drawingData) {
                const img = new Image();
                img.onload = function() {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    saveState();
                };
                img.src = drawingData;
            }
            
            // Delete a drawing
            function deleteDrawing(index) {
                if (confirm('Are you sure you want to delete this drawing?')) {
                    let savedDrawings = JSON.parse(localStorage.getItem('kidDrawings') || '[]');
                    savedDrawings.splice(index, 1);
                    localStorage.setItem('kidDrawings', JSON.stringify(savedDrawings));
                    loadGallery();
                }
            }
            
            // Initialize shape buttons
            function initShapeButtons() {
                const shapeButtons = document.querySelectorAll('.shape-btn');
                
                shapeButtons.forEach(btn => {
                    btn.addEventListener('click', function() {
                        // Clear previously selected shape
                        shapeButtons.forEach(b => b.classList.remove('selected'));
                        
                        // Set new selected shape
                        this.classList.add('selected');
                        selectedShape = this.dataset.shape;
                        
                        // Bounce animation
                        this.classList.add('bounce');
                        setTimeout(() => {
                            this.classList.remove('bounce');
                        }, 500);
                    });
                });
                
                // Select rectangle by default
                if (shapeButtons.length > 0) {
                    shapeButtons[0].classList.add('selected');
                    selectedShape = 'rectangle';
                }
            }
            
            // Tool selection
            document.getElementById('pen-btn').addEventListener('click', function() {
                currentTool = 'pen';
                selectedSticker = null;
                selectedShape = null;
                
                // Update tool buttons
                document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');
                
                // Show/hide appropriate containers
                document.querySelector('.stickers-container').style.display = 'none';
                document.querySelector('.shapes-container').style.display = 'none';
                document.querySelector('.color-picker').style.display = 'flex';
                
                // Update right panel title
                document.getElementById('right-panel-title').textContent = 'Colors';
                
                canvas.style.cursor = 'crosshair';
            });
            
            document.getElementById('shape-btn').addEventListener('click', function() {
                currentTool = 'shape';
                selectedSticker = null;
                
                // Select first shape if none selected
                if (!selectedShape && document.querySelector('.shape-btn')) {
                    const firstShapeBtn = document.querySelector('.shape-btn');
                    firstShapeBtn.classList.add('selected');
                    selectedShape = firstShapeBtn.dataset.shape;
                }
                
                // Update tool buttons
                document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');
                
                // Show/hide appropriate containers
                document.querySelector('.stickers-container').style.display = 'none';
                document.querySelector('.shapes-container').style.display = 'flex';
                document.querySelector('.color-picker').style.display = 'flex';
                
                // Update right panel title
                document.getElementById('right-panel-title').textContent = 'Shapes';
                
                canvas.style.cursor = 'crosshair';
            });
            
            document.getElementById('sticker-btn').addEventListener('click', function() {
                currentTool = 'sticker';
                selectedShape = null;
                
                // Select first sticker if none selected
                if (!selectedSticker && document.querySelector('.sticker')) {
                    const firstSticker = document.querySelector('.sticker');
                    firstSticker.style.backgroundColor = '#ddeeff';
                    firstSticker.classList.add('selected');
                    selectedSticker = firstSticker.dataset.emoji; // Use the emoji from dataset
                }
                
                // Update tool buttons
                document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');
                
                // Show/hide appropriate containers
                document.querySelector('.stickers-container').style.display = 'flex';
                document.querySelector('.shapes-container').style.display = 'none';
                document.querySelector('.color-picker').style.display = 'none';
                
                // Update right panel title
                document.getElementById('right-panel-title').textContent = 'Stickers';
                
                canvas.style.cursor = 'pointer';
            });
            
            document.getElementById('fill-btn').addEventListener('click', function() {
                currentTool = 'fill';
                selectedShape = null;
                selectedSticker = null;
                
                // Update tool buttons
                document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');
                
                // Show/hide appropriate containers
                document.querySelector('.stickers-container').style.display = 'none';
                document.querySelector('.shapes-container').style.display = 'none';
                document.querySelector('.color-picker').style.display = 'flex';
                
                // Update right panel title
                document.getElementById('right-panel-title').textContent = 'Colors';
                
                canvas.style.cursor = 'url("data:image/svg+xml;utf8,<svg xmlns=\'http://www.w3.org/2000/svg\' width=\'24\' height=\'24\' viewBox=\'0 0 24 24\'><path d=\'M19 11h-4c-.55 0-1-.45-1-1V6c0-1.1-.9-2-2-2h-3C5.9 4 4 5.9 4 9v9c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2v-5c0-1.1-.9-2-2-2z\'/></svg>") 0 24, auto';
            });
            
            // Event listeners
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            
            // Touch support
            canvas.addEventListener('touchstart', function(e) {
                e.preventDefault();
                startDrawing(e);
            });
            canvas.addEventListener('touchmove', function(e) {
                e.preventDefault();
                draw(e);
            });
            canvas.addEventListener('touchend', stopDrawing);
            
            // Button actions
            document.getElementById('undo-btn').addEventListener('click', function() {
                undo();
                this.classList.add('bounce');
                setTimeout(() => {
                    this.classList.remove('bounce');
                }, 500);
            });
            
            document.getElementById('redo-btn').addEventListener('click', function() {
                redo();
                this.classList.add('bounce');
                setTimeout(() => {
                    this.classList.remove('bounce');
                }, 500);
            });
            
            document.getElementById('clear-btn').addEventListener('click', function() {
                if (confirm('Are you sure you want to clear your drawing?')) {
                    clearCanvas();
                    this.classList.add('bounce');
                    setTimeout(() => {
                        this.classList.remove('bounce');
                    }, 500);
                }
            });
            document.getElementById('save-btn').addEventListener('click', saveDrawing);
            
            // Brush size slider
            document.getElementById('brush-size').addEventListener('input', function() {
                brushSize = this.value;
            });
            
            // Window resize handling
            window.addEventListener('resize', resizeCanvas);
            
            // Initialize
            initCanvas();
            initColors();
            initStickers();
            initShapeButtons();
            loadGallery();
        });
    </script>
</body>
</html>
